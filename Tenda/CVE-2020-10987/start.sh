#!/bin/sh

echo "Starting Tenda firmware container..."

# 挂载必要的文件系统
mount -t proc proc /proc 2>/dev/null || true
mount -t sysfs sysfs /sys 2>/dev/null || true

# 配置网络
ifconfig eth0 192.168.2.2/24 up

# 检查并应用补丁
echo "Checking for patch files..."
ls -la /tools/ 2>/dev/null || echo "Tools directory not found or empty"

if [ -f /tools/patch.sh ]; then
    echo "Found patch.sh, applying patches..."
    echo "File details:"
    file /tools/patch.sh 2>/dev/null || echo "file command not available"
    head -1 /tools/patch.sh
    chmod +x /tools/patch.sh
    
    # 尝试直接用 sh 执行
    echo "Trying to execute with sh..."
    sh /tools/patch.sh
elif [ -f /tools/patch-firmware.sh ]; then
    echo "Found patch-firmware.sh, applying patches..."
    chmod +x /tools/patch-firmware.sh
    sh /tools/patch-firmware.sh
else
    echo "No patch file found, skipping patches"
fi

# 启动 httpd
echo "Starting httpd..."
/bin/httpd &

echo "Httpd started, container ready"
echo "Web interface available at: http://192.168.2.2"

# 保持容器运行 (用 sleep 替代 tail)
while true; do
    sleep 3600
done
