#!/bin/bash

# 网络环境切换脚本

show_usage() {
    echo "用法: $0 [current|demo1|demo2|custom]"
    echo ""
    echo "网络环境:"
    echo "  current  - 当前环境 (118.202.11.x/24)"
    echo "  demo1    - 演示环境1 (192.168.101.x/24)" 
    echo "  demo2    - 演示环境2 (10.10.3.x/24)"
    echo "  custom   - 自定义网段"
    echo ""
    echo "示例:"
    echo "  $0 current              # 使用当前网络配置"
    echo "  $0 demo1               # 切换到演示环境1"
    echo "  $0 custom 172.16.1     # 自定义使用172.16.1.x/24网段"
}

if [ $# -eq 0 ]; then
    show_usage
    exit 1
fi

case "$1" in
    "current")
        echo "使用当前网络配置 (118.202.11.x/24)"
        cp docker-compose.yml docker-compose.yml.backup 2>/dev/null
        ;;
    "demo1")
        echo "切换到演示环境1 (192.168.101.x/24)"
        cp network-configs/docker-compose-demo1.yml docker-compose.yml
        ;;
    "demo2") 
        echo "切换到演示环境2 (10.10.3.x/24)"
        cp network-configs/docker-compose-demo2.yml docker-compose.yml
        ;;
    "custom")
        if [ $# -ne 2 ]; then
            echo "错误: 自定义模式需要指定网段前缀"
            echo "示例: $0 custom 172.16.1"
            exit 1
        fi
        network_prefix="$2"
        echo "使用自定义网段 (${network_prefix}.x/24)"
        
        cat > docker-compose.yml << EOF
version: "3.8"

networks:
  iot_bridge:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: ${network_prefix}.0/24
          gateway: ${network_prefix}.1

services:
  system-emu:
    container_name: tenda-system
    build:
      context: .
      dockerfile: ./system-emu/Dockerfile
    networks:
      iot_bridge:
        ipv4_address: ${network_prefix}.10
    privileged: true
EOF
        ;;
    *)
        echo "错误: 无效的网络环境 '$1'"
        show_usage
        exit 1
        ;;
esac

echo ""
echo "网络配置已更新！"
echo ""
echo "启动容器:"
echo "  docker-compose up -d"
echo ""
echo "查看容器IP:"  
echo "  docker inspect tenda-system | grep IPAddress"
echo ""
echo "连接说明:"
echo "  - 容器SSH: ssh root@<容器IP>:22"
echo "  - QEMU虚拟机: 192.168.2.2"
echo "  - 固件Web服务: http://192.168.2.2/"
