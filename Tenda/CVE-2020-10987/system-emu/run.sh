#!/bin/bash

# 启动 ssh 服务
/etc/init.d/ssh start

# 配置TAP网络 - 与容器在同一网段
# 容器IP: 10.10.10.168，TAP网关: 10.10.10.1，QEMU虚拟机: 10.10.10.169
tunctl -t tap0
ifconfig tap0 10.10.10.1/24 up

# 启用IP转发，确保TAP和容器网络互通
echo 1 > /proc/sys/net/ipv4/ip_forward

# 添加路由，确保数据包能够在TAP和容器网络间路由
ip route add 10.10.10.169/32 dev tap0

# 启动 http 服务，用于传输固件文件
nohup python3 -m http.server 8000 1>&/dev/null &

# 进入 qemu 镜像目录
cd /root/images

/usr/bin/expect<<EOF
set timeout 10000
spawn qemu-system-arm -M vexpress-a9 -kernel vmlinuz-3.2.0-4-vexpress -initrd initrd.img-3.2.0-4-vexpress -drive if=sd,file=debian_wheezy_armhf_standard.qcow2 -append "root=/dev/mmcblk0p2" -net nic -net tap,ifname=tap0,script=no,downscript=no -nographic

expect "debian-armhf login:"
send "root\r"
expect "Password:"
send "root\r"

expect "root@debian-armhf:~# "
send "ifconfig eth0 10.10.10.169/24\r"

expect "root@debian-armhf:~# "
send "route add default gw 10.10.10.1\r"

#expect "root@debian-armhf:~# "
#send "echo 0 > /proc/sys/kernel/randomize_va_space\r"

expect "root@debian-armhf:~# "
send "scp root@10.10.10.168:/root/squashfs-root.tar.gz /root/squashfs-root.tar.gz\r"
expect {
    "(yes/no)? " { send "yes\r"; exp_continue }
    "password: " { send "root\r" }
}

expect "root@debian-armhf:~# "
send "tar xzf squashfs-root.tar.gz && rm squashfs-root.tar.gz\r"
expect "root@debian-armhf:~# "
send "mount -o bind /dev ./squashfs-root/dev && mount -t proc /proc ./squashfs-root/proc\r"

expect "root@debian-armhf:~# "
send "scp -r root@10.10.10.168:/root/tools /root/squashfs-root/tools\r"
expect {
    "(yes/no)? " { send "yes\r"; exp_continue }
    "password: " { send "root\r" }
}

expect "root@debian-armhf:~# "
send "chroot squashfs-root/ sh\r"
expect "# "
send "chmod +x tools/patch.sh && /bin/sh tools/patch.sh\r"
expect "# "
send "brctl addbr br0\r"
expect "# "
send "brctl addif br0 eth0\r"
expect "# "
send "ifconfig br0 10.10.10.169/24 up\r"
expect "# "
send "ifconfig eth0 0.0.0.0 up\r"
expect "# "
send "/bin/httpd\r"

expect eof
EOF
